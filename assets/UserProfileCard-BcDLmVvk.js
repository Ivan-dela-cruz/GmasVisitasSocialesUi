import{g as ie,R,r as w,j as e,G as x,a as g,F,k as B,l as D,t as L,U as oe,V as le,B as U,S as P,m as T,A as G,w as M,x as V,y as H,C as O,z as J,p as K,o as d,D as Q,q as X,s as Y,v as Z,P as $}from"./index-DlGxA0AR.js";import{u as ce,C as E}from"./index.esm-DuBBEoLH.js";import{c as de,i as me,e as ue}from"./users-C4kYjLV8.js";import{u as _,a as ee,b as se,c as re}from"./companies-Cs-1lFJO.js";import{T as I}from"./TextField-Dbihm-yT.js";import{I as z}from"./InputLabel-CAS4qYAm.js";import{F as xe}from"./FormHelperText-BjerNUfA.js";import{C as W}from"./CircularProgress-9Q1cfhaT.js";import{T as ae}from"./Trash-BXUkiIWs.js";import{u as ge,C as he}from"./useConfirmDialog-B4uIsMqU.js";const pe=({user:t=null,isEdit:l=!1})=>{const i=ie(),[h,f]=R.useState(!1),[m,v]=w.useState(""),[u,A]=w.useState(!1),{userCompanies:c,userCompaniesLoading:b,mutateUserCompanies:y}=_(l&&t?t.id:null),{companies:p,companiesLoading:N}=ee(),{control:a,handleSubmit:k,reset:q,formState:{errors:j}}=ce({defaultValues:{userName:"",email:"",fullName:"",password:"",confirmPassword:"",role:"User",isActive:!0}});w.useEffect(()=>{t&&l&&q({userName:t.userName||"",email:t.email||"",fullName:t.fullName||"",role:t.role||"User",isActive:t.isActive??!0,password:"",confirmPassword:""})},[t,l,q]);const n=async s=>{if(!l){if(!s.password){d({open:!0,message:"La contraseña es requerida",variant:"alert",alert:{color:"warning"}});return}if(s.password!==s.confirmPassword){d({open:!0,message:"Las contraseñas no coinciden",variant:"alert",alert:{color:"warning"}});return}}f(!0);try{const r={userName:s.userName,email:s.email,fullName:s.fullName,role:s.role,isActive:s.isActive};l||(r.password=s.password),l&&t?(await de({...r,id:t.id}),d({open:!0,message:"Usuario actualizado exitosamente",variant:"alert",alert:{color:"success"}})):(await me(r),d({open:!0,message:"Usuario creado exitosamente",variant:"alert",alert:{color:"success"}})),i("/apps/users/list")}catch(r){d({open:!0,message:r.message||"Error al guardar el usuario",variant:"alert",alert:{color:"error"}})}finally{f(!1)}},C=()=>{i("/apps/users/list")},o=R.useMemo(()=>{if(!p||!c)return p||[];const s=c.map(r=>r.companyId);return p.filter(r=>!s.includes(r.id))},[p,c]),S=async()=>{if(!(!m||!t)){A(!0);try{await se(t.id,m),await y(),v(""),d({open:!0,message:"Empresa asignada exitosamente",variant:"alert",alert:{color:"success"}})}catch{d({open:!0,message:"Error al asignar la empresa",variant:"alert",alert:{color:"error"}})}finally{A(!1)}}},ne=async s=>{if(t&&window.confirm("¿Está seguro de desasignar esta empresa del usuario?"))try{await re(s,t.id),await y(),d({open:!0,message:"Empresa desasignada exitosamente",variant:"alert",alert:{color:"success"}})}catch{d({open:!0,message:"Error al desasignar la empresa",variant:"alert",alert:{color:"error"}})}};return e.jsx("form",{onSubmit:k(n),children:e.jsxs(x,{container:!0,spacing:3,children:[e.jsx(x,{item:!0,xs:12,children:e.jsx(g,{variant:"h5",gutterBottom:!0,children:"Información general"})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(E,{name:"userName",control:a,rules:{required:"El nombre de usuario es requerido"},render:({field:s})=>{var r;return e.jsx(I,{...s,fullWidth:!0,label:"Nombre de Usuario *",error:!!j.userName,helperText:(r=j.userName)==null?void 0:r.message,disabled:l})}})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(E,{name:"fullName",control:a,rules:{required:"El nombre completo es requerido"},render:({field:s})=>{var r;return e.jsx(I,{...s,fullWidth:!0,label:"Nombre Completo *",error:!!j.fullName,helperText:(r=j.fullName)==null?void 0:r.message})}})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(E,{name:"email",control:a,rules:{required:"El email es requerido",pattern:{value:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,message:"Email inválido"}},render:({field:s})=>{var r;return e.jsx(I,{...s,fullWidth:!0,label:"Email *",type:"email",error:!!j.email,helperText:(r=j.email)==null?void 0:r.message})}})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(E,{name:"role",control:a,render:({field:s})=>e.jsxs(F,{fullWidth:!0,children:[e.jsx(z,{children:"Rol"}),e.jsxs(B,{...s,label:"Rol",children:[e.jsx(D,{value:"Admin",children:"Admin"}),e.jsx(D,{value:"User",children:"User"})]})]})})}),!l&&e.jsxs(e.Fragment,{children:[e.jsx(x,{item:!0,xs:12,children:e.jsx(g,{variant:"h5",gutterBottom:!0,sx:{mt:2},children:"Contraseña"})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(E,{name:"password",control:a,rules:{required:l?!1:"La contraseña es requerida",minLength:{value:6,message:"Mínimo 6 caracteres"}},render:({field:s})=>{var r;return e.jsx(I,{...s,fullWidth:!0,label:"Contraseña *",type:"password",error:!!j.password,helperText:(r=j.password)==null?void 0:r.message})}})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(E,{name:"confirmPassword",control:a,rules:{required:l?!1:"Confirme la contraseña"},render:({field:s})=>{var r;return e.jsx(I,{...s,fullWidth:!0,label:"Confirmar Contraseña *",type:"password",error:!!j.confirmPassword,helperText:(r=j.confirmPassword)==null?void 0:r.message})}})})]}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(E,{name:"isActive",control:a,render:({field:s})=>e.jsxs(F,{fullWidth:!0,children:[e.jsx(z,{children:"Estado"}),e.jsxs(B,{...s,label:"Estado",value:s.value?"true":"false",onChange:r=>s.onChange(r.target.value==="true"),children:[e.jsx(D,{value:"true",children:"Activo"}),e.jsx(D,{value:"false",children:"Inactivo"})]})]})})}),l&&e.jsx(x,{item:!0,xs:12,children:e.jsx(xe,{children:'Nota: Para cambiar la contraseña, use la opción "Cambiar Contraseña" en la lista de usuarios'})}),l&&t&&e.jsxs(e.Fragment,{children:[e.jsx(x,{item:!0,xs:12,children:e.jsx(L,{sx:{my:2}})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(g,{variant:"h5",gutterBottom:!0,children:"Empresas Asignadas"})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(oe,{variant:"outlined",children:e.jsxs(le,{children:[e.jsxs(U,{sx:{mb:3},children:[e.jsx(g,{variant:"subtitle1",gutterBottom:!0,sx:{mb:2},children:"Asignar Nueva Empresa"}),e.jsxs(P,{direction:"row",spacing:2,alignItems:"center",children:[e.jsxs(F,{fullWidth:!0,sx:{maxWidth:400},children:[e.jsx(z,{children:"Seleccione Empresa"}),e.jsx(B,{value:m,onChange:s=>v(s.target.value),label:"Seleccione Empresa",disabled:N||u||!(o!=null&&o.length),children:o==null?void 0:o.map(s=>e.jsxs(D,{value:s.id,children:[s.code," - ",s.name]},s.id))})]}),e.jsx(T,{variant:"contained",startIcon:u?e.jsx(W,{size:16}):e.jsx(G,{}),onClick:S,disabled:!m||u,children:"Asignar"})]}),!(o!=null&&o.length)&&!N&&e.jsx(g,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Todas las empresas disponibles ya están asignadas"})]}),e.jsx(L,{sx:{my:2}}),e.jsxs(U,{children:[e.jsxs(g,{variant:"subtitle1",gutterBottom:!0,sx:{mb:2},children:["Empresas Asignadas (",(c==null?void 0:c.length)||0,")"]}),b?e.jsx(U,{sx:{display:"flex",justifyContent:"center",py:3},children:e.jsx(W,{})}):c&&c.length>0?e.jsx(M,{children:c.map(s=>{const r=p==null?void 0:p.find(te=>te.id===s.companyId);return e.jsxs(V,{sx:{border:1,borderColor:"divider",borderRadius:1,mb:1,bgcolor:"background.paper"},children:[e.jsx(H,{primary:e.jsxs(P,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(O,{label:(r==null?void 0:r.code)||s.companyId,size:"small",color:"primary"}),e.jsx(g,{variant:"subtitle2",children:(r==null?void 0:r.name)||"Empresa"})]}),secondary:s.assignedAt?`Asignada el: ${new Date(s.assignedAt).toLocaleDateString("es-ES")}`:null}),e.jsx(J,{children:e.jsx(K,{edge:"end",color:"error",onClick:()=>ne(s.id),children:e.jsx(ae,{size:18})})})]},s.id)})}):e.jsx(g,{variant:"body2",color:"text.secondary",sx:{py:2,textAlign:"center"},children:"No hay empresas asignadas a este usuario"})]})]})})})]}),e.jsx(x,{item:!0,xs:12,children:e.jsxs(P,{direction:"row",spacing:2,justifyContent:"flex-end",sx:{mt:3},children:[e.jsx(T,{variant:"outlined",color:"secondary",onClick:C,disabled:h,children:"Cancelar"}),e.jsx(T,{variant:"contained",type:"submit",disabled:h,children:h?e.jsx(W,{size:24}):l?"Actualizar":"Guardar"})]})})]})})},Pe=pe,je=({open:t,onClose:l,user:i})=>{const[h,f]=w.useState(!1),[m,v]=w.useState(""),[u,A]=w.useState(""),[c,b]=w.useState({}),y=()=>{v(""),A(""),b({}),l()},p=()=>{const a={};return m?m.length<6&&(a.newPassword="La contraseña debe tener al menos 6 caracteres"):a.newPassword="La contraseña es requerida",u?m!==u&&(a.confirmPassword="Las contraseñas no coinciden"):a.confirmPassword="Confirme la contraseña",b(a),Object.keys(a).length===0},N=async()=>{if(p()){f(!0);try{await ue(i.userName,m),d({open:!0,message:"Contraseña cambiada exitosamente",variant:"alert",alert:{color:"success"}}),y()}catch(a){d({open:!0,message:a.message||"Error al cambiar la contraseña",variant:"alert",alert:{color:"error"}})}finally{f(!1)}}};return e.jsxs(Q,{open:t,onClose:y,maxWidth:"sm",fullWidth:!0,children:[e.jsx(X,{children:"Cambiar Contraseña"}),e.jsx(Y,{children:e.jsxs(P,{spacing:2,sx:{mt:2},children:[e.jsxs(g,{variant:"body2",color:"text.secondary",children:["Usuario: ",e.jsx("strong",{children:i==null?void 0:i.userName})]}),e.jsx(I,{fullWidth:!0,label:"Nueva Contraseña",type:"password",value:m,onChange:a=>v(a.target.value),error:!!c.newPassword,helperText:c.newPassword,disabled:h}),e.jsx(I,{fullWidth:!0,label:"Confirmar Contraseña",type:"password",value:u,onChange:a=>A(a.target.value),error:!!c.confirmPassword,helperText:c.confirmPassword,disabled:h})]})}),e.jsxs(Z,{children:[e.jsx(T,{onClick:y,disabled:h,children:"Cancelar"}),e.jsx(T,{variant:"contained",onClick:N,disabled:h,children:h?e.jsx(W,{size:24}):"Cambiar Contraseña"})]})]})},Te=je,fe=({open:t,onClose:l,user:i})=>{const[h,f]=w.useState(!1),[m,v]=w.useState(""),{dialogState:u,openDialog:A,closeDialog:c}=ge(),{userCompanies:b,userCompaniesLoading:y}=_(i==null?void 0:i.id),{companies:p,companiesLoading:N}=ee(),a=()=>{v(""),l()},k=p.filter(n=>!b.some(C=>C.companyId===n.id)),q=async()=>{if(!m){d({open:!0,message:"Seleccione una empresa",variant:"alert",alert:{color:"warning"}});return}f(!0);try{await se(i.id,m),d({open:!0,message:"Empresa asignada exitosamente",variant:"alert",alert:{color:"success"}}),v("")}catch(n){d({open:!0,message:n.message||"Error al asignar empresa",variant:"alert",alert:{color:"error"}})}finally{f(!1)}},j=async n=>{const C=p.find(S=>S.id===n.companyId),o=(C==null?void 0:C.name)||n.companyName||"esta empresa";A({title:"Desasignar Empresa",message:`¿Está seguro de desasignar la empresa "${o}"?`,severity:"warning",confirmText:"Desasignar",onConfirm:async()=>{f(!0);try{await re(n.id,i.id),d({open:!0,message:"Empresa desasignada exitosamente",variant:"alert",alert:{color:"success"}})}catch(S){d({open:!0,message:S.message||"Error al desasignar empresa",variant:"alert",alert:{color:"error"}})}finally{f(!1)}}})};return e.jsxs(Q,{open:t,onClose:a,maxWidth:"md",fullWidth:!0,children:[e.jsx(X,{children:"Asignar Empresas"}),e.jsx(Y,{children:e.jsxs(P,{spacing:3,sx:{mt:1},children:[e.jsxs(g,{variant:"body2",color:"text.secondary",children:["Usuario: ",e.jsx("strong",{children:i==null?void 0:i.userName})," (",i==null?void 0:i.fullName,")"]}),e.jsx(L,{}),e.jsxs(U,{children:[e.jsx(g,{variant:"h6",gutterBottom:!0,children:"Asignar Nueva Empresa"}),e.jsxs(P,{direction:"row",spacing:2,alignItems:"flex-start",children:[e.jsxs(F,{fullWidth:!0,disabled:N||h,children:[e.jsx(z,{children:"Seleccionar Empresa"}),e.jsx(B,{value:m,onChange:n=>v(n.target.value),label:"Seleccionar Empresa",children:k.map(n=>e.jsxs(D,{value:n.id,children:[n.code," - ",n.name]},n.id))})]}),e.jsx(T,{variant:"contained",startIcon:e.jsx(G,{}),onClick:q,disabled:h||!m,children:"Asignar"})]}),k.length===0&&!N&&e.jsx(g,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"No hay empresas disponibles para asignar"})]}),e.jsx(L,{}),e.jsxs(U,{children:[e.jsx(g,{variant:"h6",gutterBottom:!0,children:"Empresas Asignadas"}),y?e.jsx(W,{}):b.length===0?e.jsx(g,{variant:"body2",color:"text.secondary",children:"No hay empresas asignadas"}):e.jsx(M,{children:b.map((n,C)=>{const o=p.find(S=>S.id===n.companyId);return e.jsxs(R.Fragment,{children:[e.jsxs(V,{sx:{border:1,borderColor:"divider",borderRadius:1,mb:1,bgcolor:"background.paper"},children:[e.jsx(H,{primary:e.jsxs(P,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(O,{label:(o==null?void 0:o.code)||"N/A",size:"small",color:"primary"}),e.jsx(g,{variant:"subtitle2",children:(o==null?void 0:o.name)||"Empresa desconocida"})]}),secondary:`Asignada el: ${new Date(n.createdAt||Date.now()).toLocaleDateString("es-ES")}`}),e.jsx(J,{children:e.jsx(K,{edge:"end",color:"error",onClick:()=>j(n),disabled:h,children:e.jsx(ae,{size:20})})})]}),C<b.length-1&&e.jsx(L,{})]},n.id)})})]})]})}),e.jsx(Z,{children:e.jsx(T,{onClick:a,disabled:h,children:"Cerrar"})}),e.jsx(he,{open:u.open,title:u.title,message:u.message,onConfirm:u.onConfirm,onCancel:c,confirmText:u.confirmText,cancelText:u.cancelText,severity:u.severity})]})},De=fe;$.object,$.func;export{De as A,Te as C,Pe as U};
