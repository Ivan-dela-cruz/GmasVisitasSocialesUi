import{g as ce,i as de,h as me,r as n,j as e,C as y,a as r,B as i,S as l,M as N,m as F,A as H,t as G,F as pe,k as ge,l as K,w as ue,R as ye,x as he,y as xe,z as fe,p as je,o as t}from"./index-DlGxA0AR.js";import{u as be}from"./index.esm-DuBBEoLH.js";import{B}from"./index-7Qti63TH.js";import{a as Ce,b as ve}from"./companyVisitGroups-OtSfEFTa.js";import{u as Se,a as Ae,d as Ee,b as Ie,c as we,e as Ne,f as Ge}from"./userCompanyVisitGroups-AWgWdgSa.js";import{u as ke}from"./users-C4kYjLV8.js";import{C as Te}from"./CompanyVisitGroupForm-bckc6HCC.js";import{u as Ve,C as Re}from"./useConfirmDialog-B4uIsMqU.js";import{C as S}from"./Checkbox-CdHpUIEu.js";import{C as x}from"./CircularProgress-9Q1cfhaT.js";import{T as O}from"./Trash-BXUkiIWs.js";import{I as Ue}from"./InputLabel-CAS4qYAm.js";import"./ArrowLeft-DgXiCSs-.js";import"./TextField-Dbihm-yT.js";import"./FormHelperText-BjerNUfA.js";import"./TableDocument-DWQb3OC6.js";import"./index-ByAXKYUS.js";import"./getImageUrl-uZoa92S7.js";import"./Switch-DSnvG_gT.js";function es(){const k=ce(),{id:m}=de(),{selectedCompany:A}=me(),[P,T]=n.useState(!1),[f,c]=n.useState(!1),[p,V]=n.useState({}),[g,R]=n.useState({}),[j,U]=n.useState(""),{dialogState:u,openDialog:L,closeDialog:M}=Ve(),{companyVisitGroup:d,companyVisitGroupLoading:W,companyVisitGroupError:$}=Ce(m),{employeeCompanies:q,employeeCompaniesLoading:J}=Se(A==null?void 0:A.companyId),{employeeCompanyVisitGroups:E,employeeCompanyVisitGroupsLoading:Q,refreshEmployeeCompanyVisitGroups:b}=Ae(m),{users:z,usersLoading:X}=ke(),{userCompanyVisitGroups:h,userCompanyVisitGroupsLoading:Y,refreshUserCompanyVisitGroups:C}=Ee(m),{control:Z,handleSubmit:_,reset:D,formState:{errors:ee}}=be({defaultValues:{code:"",name:"",description:"",status:!0}});n.useEffect(()=>{d&&D({code:d.code||"",name:d.name||"",description:d.description||"",status:d.status??!0})},[d,D]);const se=async s=>{T(!0);try{const a={id:d.id,...s,companyId:d.companyId};await ve(a),t({open:!0,message:"Grupo actualizado exitosamente",variant:"alert",alert:{color:"success"}}),k("/apps/visits/groups/list")}catch(a){t({open:!0,message:a.message||"Error al actualizar el grupo",variant:"alert",alert:{color:"error"}})}finally{T(!1)}},ae=()=>{k("/apps/visits/groups/list")},I=q.filter(s=>!E.some(a=>a.employeeCompanyId===s.id)),oe=n.useMemo(()=>[{id:"select",header:({table:s})=>e.jsx(S,{checked:s.getIsAllPageRowsSelected(),indeterminate:s.getIsSomePageRowsSelected(),onChange:a=>{s.getToggleAllPageRowsSelectedHandler()(a)},sx:{padding:0}}),cell:({row:s})=>e.jsx(S,{checked:s.getIsSelected(),disabled:!s.getCanSelect(),onChange:a=>{s.getToggleSelectedHandler()(a)},sx:{padding:0}}),enableColumnFilter:!1,enableSorting:!1,enableHiding:!1,size:50,meta:{skipFilter:!0}},{header:"Código",accessorKey:"codeEmployee",cell:({getValue:s})=>e.jsx(y,{label:s()||"N/A",size:"small",color:"primary",variant:"light"}),size:100},{header:"Identificación",accessorKey:"employeeIdentification",cell:({getValue:s})=>e.jsx(r,{variant:"body2",children:s()||"N/A"})},{header:"Nombres",accessorKey:"employeeFirstName",cell:({getValue:s})=>e.jsx(r,{variant:"body2",sx:{fontWeight:500},children:s()||"N/A"})},{header:"Apellidos",accessorKey:"employeeLastName",cell:({getValue:s})=>e.jsx(r,{variant:"body2",sx:{fontWeight:500},children:s()||"N/A"})},{header:"Estado",accessorKey:"status",cell:({getValue:s})=>e.jsx(y,{label:s()?"Activo":"Inactivo",color:s()?"success":"error",size:"small",variant:"light"}),size:100}],[]),re=n.useMemo(()=>[{id:"select",header:({table:s})=>e.jsx(S,{checked:s.getIsAllPageRowsSelected(),indeterminate:s.getIsSomePageRowsSelected(),onChange:a=>{s.getToggleAllPageRowsSelectedHandler()(a)},sx:{padding:0}}),cell:({row:s})=>e.jsx(S,{checked:s.getIsSelected(),disabled:!s.getCanSelect(),onChange:a=>{s.getToggleSelectedHandler()(a)},sx:{padding:0}}),enableColumnFilter:!1,enableSorting:!1,enableHiding:!1,size:50,meta:{skipFilter:!0}},{header:"Código",accessorKey:"employeeCompany.codeEmployee",cell:({row:s})=>{var a;return e.jsx(y,{label:((a=s.original.employeeCompany)==null?void 0:a.codeEmployee)||"N/A",size:"small",color:"primary"})},size:100},{header:"Identificación",accessorKey:"employeeCompany.employeeIdentification",cell:({row:s})=>{var a,o,v;return e.jsx(r,{variant:"body2",children:((a=s.original.employeeCompany)==null?void 0:a.employeeIdentification)||((v=(o=s.original.employeeCompany)==null?void 0:o.employee)==null?void 0:v.identification)||"N/A"})}},{header:"Nombres",accessorKey:"employeeCompany.employeeFirstName",cell:({row:s})=>{var a;return e.jsx(r,{variant:"body2",sx:{fontWeight:500},children:((a=s.original.employeeCompany)==null?void 0:a.employeeFirstName)||"N/A"})}},{header:"Apellidos",accessorKey:"employeeCompany.employeeLastName",cell:({row:s})=>{var a;return e.jsx(r,{variant:"body2",sx:{fontWeight:500},children:((a=s.original.employeeCompany)==null?void 0:a.employeeLastName)||"N/A"})}},{header:"Teléfono",accessorKey:"employeeCompany.employee.cellphoneNumber",cell:({row:s})=>{var a,o;return e.jsx(r,{variant:"body2",children:((o=(a=s.original.employeeCompany)==null?void 0:a.employee)==null?void 0:o.cellphoneNumber)||"N/A"})}},{header:"Fecha Asignación",accessorKey:"createdAt",cell:({getValue:s})=>{const a=s();return a?new Date(a).toLocaleDateString("es-ES"):"N/A"},size:120}],[]),te=async()=>{const s=Object.keys(p).filter(a=>p[a]);if(s.length===0){t({open:!0,message:"Seleccione al menos un empleado",variant:"alert",alert:{color:"warning"}});return}c(!0);try{await Ie(s,m),t({open:!0,message:`${s.length} empleado(s) asignado(s) exitosamente`,variant:"alert",alert:{color:"success"}}),V({}),b&&b()}catch(a){t({open:!0,message:a.message||"Error al asignar empleados",variant:"alert",alert:{color:"error"}})}finally{c(!1)}},ie=async()=>{const s=Object.keys(g).filter(a=>g[a]);if(s.length===0){t({open:!0,message:"Seleccione al menos un empleado",variant:"alert",alert:{color:"warning"}});return}L({title:"Desasignar Empleados",message:`¿Está seguro de desasignar ${s.length} empleado(s)?`,severity:"warning",confirmText:"Desasignar",onConfirm:async()=>{c(!0);try{await we(s,m),t({open:!0,message:`${s.length} empleado(s) desasignado(s) exitosamente`,variant:"alert",alert:{color:"success"}}),R({}),b&&b()}catch(a){t({open:!0,message:a.message||"Error al desasignar empleados",variant:"alert",alert:{color:"error"}})}finally{c(!1)}}})},w=n.useMemo(()=>z.filter(s=>!h.some(a=>a.userId===s.id)),[z,h]),ne=async()=>{if(!j){t({open:!0,message:"Seleccione un usuario",variant:"alert",alert:{color:"warning"}});return}c(!0);try{await Ne(j,m),t({open:!0,message:"Usuario asignado exitosamente",variant:"alert",alert:{color:"success"}}),U(""),C&&C()}catch(s){t({open:!0,message:s.message||"Error al asignar usuario",variant:"alert",alert:{color:"error"}})}finally{c(!1)}},le=s=>{const a=s.user,o=(a==null?void 0:a.fullName)||(a==null?void 0:a.userName)||"este usuario";L({title:"Desasignar Usuario",message:`¿Está seguro de desasignar al usuario "${o}"?`,severity:"warning",confirmText:"Desasignar",onConfirm:async()=>{c(!0);try{await Ge(s.id,m),t({open:!0,message:"Usuario desasignado exitosamente",variant:"alert",alert:{color:"success"}}),C&&C()}catch(v){t({open:!0,message:v.message||"Error al desasignar usuario",variant:"alert",alert:{color:"error"}})}finally{c(!1)}}})};return W?e.jsx(i,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(x,{})}):$?e.jsx(i,{sx:{p:3},children:e.jsx(r,{color:"error",children:"Error al cargar el grupo"})}):e.jsxs(e.Fragment,{children:[e.jsxs(l,{spacing:3,children:[e.jsx(N,{title:"Editar Grupo de Visitas",children:e.jsx(l,{spacing:3,children:e.jsx(Te,{control:Z,handleSubmit:_,onSubmit:se,loading:P,onCancel:ae,errors:ee,isEdit:!0})})}),e.jsx(N,{title:"Empleados Asignados",children:e.jsxs(l,{spacing:3,children:[e.jsxs(i,{children:[e.jsxs(l,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsxs(r,{variant:"h6",children:["Empleados Disponibles (",I.length,")"]}),e.jsxs(F,{variant:"contained",startIcon:e.jsx(H,{}),onClick:te,disabled:f||Object.keys(p).filter(s=>p[s]).length===0,children:["Asignar Seleccionados (",Object.keys(p).filter(s=>p[s]).length,")"]})]}),J?e.jsx(i,{display:"flex",justifyContent:"center",p:3,children:e.jsx(x,{})}):I.length===0?e.jsx(r,{variant:"body2",color:"text.secondary",children:"No hay empleados disponibles para asignar"}):e.jsx(i,{sx:{maxHeight:400,overflow:"auto"},children:e.jsx(B,{data:I,columns:oe,enableRowSelection:!0,filterOnHeaderVisible:!0,tableId:"assignEmployeesEditTable",onRowSelectionChange:V,rowSelection:p})})]}),e.jsx(G,{}),e.jsx(i,{children:Q?e.jsx(i,{display:"flex",justifyContent:"center",p:3,children:e.jsx(x,{})}):E.length===0?e.jsx(r,{variant:"body2",color:"text.secondary",children:"No hay empleados asignados a este grupo"}):e.jsx(i,{sx:{maxHeight:400,overflow:"auto"},children:e.jsx(B,{title:"Empleados Asignados",toolbarButtons:[{label:`Desasignar Seleccionados (${Object.keys(g).filter(s=>g[s]).length})`,icon:e.jsx(O,{}),toolTip:"Desasignar empleados seleccionados",variant:"contained",color:"error",onClick:ie,disabled:Object.keys(g).filter(s=>g[s]).length===0}],data:E,columns:re,enableRowSelection:!0,filterOnHeaderVisible:!0,tableId:"assignedEmployeesEditTable",onRowSelectionChange:R,rowSelection:g,isDownload:!1})})})]})}),e.jsx(N,{title:"Usuarios Asignados",children:e.jsxs(l,{spacing:3,children:[e.jsxs(i,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Asignar Usuario"}),X?e.jsx(i,{display:"flex",justifyContent:"center",p:3,children:e.jsx(x,{})}):e.jsxs(l,{direction:"row",spacing:2,alignItems:"flex-start",children:[e.jsxs(pe,{fullWidth:!0,children:[e.jsx(Ue,{id:"select-user-label",children:"Usuario"}),e.jsx(ge,{labelId:"select-user-label",id:"select-user",value:j,label:"Usuario",onChange:s=>U(s.target.value),disabled:f||w.length===0,children:w.length===0?e.jsx(K,{value:"",children:e.jsx("em",{children:"No hay usuarios disponibles"})}):w.map(s=>e.jsx(K,{value:s.id,children:e.jsxs(l,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(r,{children:s.fullName||s.userName}),e.jsx(y,{label:s.email,size:"small",variant:"outlined"}),e.jsx(y,{label:s.role,size:"small",color:s.role==="Admin"?"primary":"default",variant:"light"})]})},s.id))})]}),e.jsx(F,{variant:"contained",startIcon:e.jsx(H,{}),onClick:ne,disabled:f||!j,sx:{minWidth:120},children:"Asignar"})]})]}),e.jsx(G,{}),e.jsxs(i,{children:[e.jsxs(r,{variant:"h6",gutterBottom:!0,children:["Lista de Usuarios (",h.length,")"]}),Y?e.jsx(i,{display:"flex",justifyContent:"center",p:3,children:e.jsx(x,{})}):h.length===0?e.jsx(r,{variant:"body2",color:"text.secondary",children:"No hay usuarios asignados a este grupo"}):e.jsx(ue,{children:h.map((s,a)=>{const o=s.user;return e.jsxs(ye.Fragment,{children:[e.jsxs(he,{sx:{border:1,borderColor:"divider",borderRadius:1,mb:1,bgcolor:"background.paper"},children:[e.jsx(xe,{primary:e.jsxs(l,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(r,{variant:"subtitle2",children:(o==null?void 0:o.fullName)||(o==null?void 0:o.userName)}),e.jsx(y,{label:o==null?void 0:o.email,size:"small",variant:"outlined"}),e.jsx(y,{label:o==null?void 0:o.role,size:"small",color:(o==null?void 0:o.role)==="Admin"?"primary":"default",variant:"light"})]}),secondary:e.jsxs(l,{spacing:.5,sx:{mt:.5},children:[e.jsxs(r,{variant:"caption",color:"text.secondary",children:["Estado: ",o!=null&&o.isActive?"Activo":"Inactivo"]}),e.jsxs(r,{variant:"caption",color:"text.secondary",children:["Asignado el: ",new Date(s.createdAt).toLocaleDateString("es-ES")]})]})}),e.jsx(fe,{children:e.jsx(je,{edge:"end",color:"error",onClick:()=>le(s),disabled:f,children:e.jsx(O,{size:20})})})]}),a<h.length-1&&e.jsx(G,{})]},s.id)})})]})]})})]}),e.jsx(Re,{open:u.open,title:u.title,message:u.message,onConfirm:u.onConfirm,onCancel:M,confirmText:u.confirmText,cancelText:u.cancelText,severity:u.severity})]})}export{es as default};
